#!/bin/bash -i
stty -echo
#???????????? ???? Sokoban
#????????? ????? ??? ??????
map=( W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W _ _ _ W W W W W W W W W W W W
W W W W W = _ _ W W W W W W W W W W W W
W W W W W _ _ = W W W W W W W W W W W W
W W W _ _ = _ = _ W W W W W W W W W W W
W W W _ W _ W W _ W W W W W W W W W W W
W _ _ _ W _ W W _ W W W W W W _ _ o o W
W _ = _ _ = _ _ _ _ _ _ _ _ _ _ _ o o W
W W W W W _ W W W _ W _ W W W _ _ o o W
W W W W W _ _ _ _ _ W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W
W W W W W W W W W W W W W W W W W W W W )

#? ??????? ????????? ?????????? ????????
x=9
y=11
#?? ???? ?? ?????? ?????? ??????? ?????????? B, ? ??????? ????? ????????? ???? ? ??????????
B=""

#????????? ??????? ????? (? ?? ???? ?????? ??????? ?????)
LIMIT=20

#??????? ?????
echo -en "\E[2J"

#? ???????? ? ???????? ?????
while ( [ "$B" != "q" ] ) do

#??????? ????? ?? ?????
for (( mx=1 ; mx<LIMIT; mx++ )) do
for (( my=1 ; my<LIMIT; my++ )) do
r=$(($mx*20+$my)) #? ??? ??? ????????? ????????, ??????? ????????? ??????????
echo -en "\E[${mx};${my}f${map[${r}]}"
done
done

#?? ???? ??????? ?????? ???????? ??????????
echo -en "\E[22;2fWASD - move, Q - quit"
echo -en "\E[23;2fW - wall, X - hero, = and @ - chest, o - place for chest"
#? ??????? - ????? (????? ?????? ?????? ? ??? ?????, ??? ?? ?????)
echo -en "\E[${x};${y}fX\E[${x};${y}f" 

#?????? ??????? ?????????? ??? ????? ? ??????????
B=""
#? ????????? ???? ??????
read -s -t 1 -n 1 B

#??????? ??????????, ? ??????? ????? ????????? ????????????? ??????????? ????????
nx=0
ny=0

#?????? ????? ??????, ? ????? ??????? ???????????? ????? ??????????? ????????
case "$B" in
  [wW]   )  nx=$(( - 1));;
  [sS]   )  nx=$(( 1));;
  [aA]   )  ny=$(( - 1));;
  [dD]   )  ny=$(( 1));;
#?? ??????, ???? ? ????-?? ????? CAPS LOCK
  [qQ]   )  B="q";; 
esac

#?????? ?????????? ??????, ?? ??????? ??????? ????? ???????
r=$(( ($x + $nx) * $LIMIT + $y + $ny ))
#? ????? - ????????? ?? ???
r2=$(( ($x + $nx + $nx) * $LIMIT + $y + $ny +$ny ))

#???? ? ???? ?????? ?????, ??
if [[ "${map[${r}]}" = "_" ]]
then
#????? ????? ?????? ??????????
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi

#?? ?????? ??? ???????? ???? ????? ??????
if [[ "${map[${r}]}" = "o" ]] 
then
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi

#???, ? ??? ???? ?????
if [[ "${map[${r}]}" = "=" ]] 
then
#???? ?? ?????? ?????, ?? ????? ???????
if [[ "${map[${r2}]}" = "_" ]] 
then
map[${r2}]="="
map[${r}]="_"
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi
#???? ????? ??? ????? ???????? - ???? ????? ???????
if [[ "${map[${r2}]}" = "o" ]] 
then
map[${r2}]="@"
map[${r}]="_"
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi
fi

#??????????? ? ??????, ??????? ????? ?? ?????
if [[ "${map[${r}]}" = "@" ]] 
then
#???? ?? ??? ????? - ??????, ??????? ????
if [[ "${map[${r2}]}" = "_" ]] 
then
map[${r2}]="="
map[${r}]="o"
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi
#???? ?? ??? ?????? ????? - ?? ???? ???????
if [[ "${map[${r2}]}" = "o" ]] 
then
map[${r2}]="@"
map[${r}]="o"
x=$(( $x + $nx ))
y=$(( $y + $ny ))
fi
fi

#???????????? ? ?????? ?? ????? ? ?????? ??????????
done       
                    
#???????????? ????? ?? Q - ???? ???????? ????? ?? ????????????? ??????
echo -en "\E[2J"